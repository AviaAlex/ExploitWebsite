<?php
use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require_once "vendor/autoload.php";
require_once 'class-db.php';

$arr_message = array();
if (isset($_POST['submit'])) {

    // check for spam
    if(!empty($_POST['honeypot'])) {
        die('Spams are not allowed!');
    }

    $db = new DB();
    if(!$db->email_exists($_POST['email'])) {

        $activation_key = sha1(mt_rand(10000,99999).time().$_POST['email']);

        $db->insert_user(
            array(
                'fullname' => $_POST['fullname'],
                'email' => $_POST['email'],
                'password' => md5($_POST['password']),
                'activation_key' => $activation_key,
            )
        );

        // send activate account email
        try {
            $mail = new PHPMailer(true);

            $mail->isSMTP();
            $mail->Host = 'SMTP_HOST'; // host
            $mail->SMTPAuth = true;
            $mail->Username = 'SMTP_API_KEY'; //username
            $mail->Password = 'SMTP_SECRET_KEY'; //password
            $mail->SMTPSecure = 'ssl';
            $mail->Port = 465; //smtp port

            $mail->setFrom('SENDER_EMAIL', 'SENDER NAME');
            $mail->addAddress($_POST['email'], $_POST['fullname']);

            $mail->isHTML(true);
            $mail->Subject = 'Activate Your Account';
            $mail->Body    = 'Hello '.ucwords($_POST['fullname']).',<br>
                            <p>Click the link below to activate your account.</p>
                            <a href="DOMAIN_URL/activate.php?key='.$activation_key.'">Activate Account</a><br>
                            Thanks,<br>Admin';

            $mail->send();
            $arr_message = array('class' => 'success', 'message' => 'We have sent an activation link on your email. Please activate your account.');
        } catch (Exception $e) {
            $arr_message = array('class' => 'error', 'message' => 'Email could not be sent. Mailer Error: '. $mail->ErrorInfo);
        }
    } else {
        $arr_message = array('class' => 'error', 'message' => 'Email is already exist.');
    }
}
?>

<?php if (!empty($arr_message)) { ?>
    <div class="<?php echo $arr_message['class']; ?>">
        <strong><?php echo $arr_message['message']; ?></strong>
    </div>
<?php } ?>

<style>
label.error {
    display: block;
    color: red;
}
</style>
<form method="post" id="frmRegistration">
    <p>
        <input type="text" name="fullname" id="fullname" placeholder="Enter Full Name" required />
    </p>
    <p>
        <input type="email" name="email" id="email" placeholder="Enter Email" required />
    </p>
    <p>
        <input type="password" name="password" id="password" placeholder="Enter Password" required />
    </p>
    <p>
        <input type="password" name="confirm-password" id="confirm-password" placeholder="Confirm Password" required />
    </p>
    <input type="hidden" name="honeypot" />
    <input type="submit" name="submit" value="Register" />
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.3/jquery.validate.min.js"></script>
<script>
jQuery(function($) {
    $('#frmRegistration').validate({
        rules: {
            "confirm-password": {
                equalTo: '#password'
            }
        }
    });
});
</script>
